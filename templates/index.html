<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-commerce</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">E-commerce</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('cart') }}">Cart</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Flash Messages -->
        <div id="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <!-- Home Section -->
        <div id="home-section" class="section" {% if section != 'home' %}style="display: none;"{% endif %}>
            <h2>Categories</h2>
            <div class="row mb-4">
                {% for category in categories %}
                <div class="col-md-3 mb-2">
                    <a href="#" class="btn btn-outline-primary">{{ category.category_name }}</a>
                </div>
                {% endfor %}
            </div>
            <h2>Products</h2>
            <div class="row">
                {% for product in products %}
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">{{ product.product_name }}</h5>
                            <p class="card-text">{{ product.description|truncate(100) }}</p>
                            <p class="card-text"><strong>Price:</strong> ₹{{ "%.2f"|format(product.price) }}</p>
                            <p class="card-text"><strong>Stock:</strong> {{ product.stock }}</p>
                            <a href="{{ url_for('product', product_id=product.product_id) }}" class="btn btn-primary">View Details</a>
                            {% if product.stock > 0 %}
                            <button onclick="addToCart({{ product.product_id }})" class="btn btn-success">Add to Cart</button>
                            {% else %}
                            <button class="btn btn-danger" disabled>Out of Stock</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Product Section -->
        <div id="product-section" class="section" {% if section != 'product' %}style="display: none;"{% endif %}>
            {% if product %}
            <h2>{{ product.product_name }}</h2>
            <div class="card">
                <div class="card-body">
                    <p><strong>Description:</strong> {{ product.description }}</p>
                    <p><strong>Price:</strong> ₹{{ "%.2f"|format(product.price) }}</p>
                    <p><strong>Stock:</strong> {{ product.stock }}</p>
                    {% if product.stock > 0 %}
                    <button onclick="addToCart({{ product.product_id }})" class="btn btn-success">Add to Cart</button>
                    {% else %}
                    <button class="btn btn-danger" disabled>Out of Stock</button>
                    {% endif %}
                    <a href="{{ url_for('index') }}" class="btn btn-secondary mt-2">← Back to Products</a>
                </div>
            </div>
            <h3 class="mt-4">Reviews</h3>
            {% if reviews %}
            <div class="list-group">
                {% for review in reviews %}
                <div class="list-group-item">
                    <p><strong>{{ review.name }}</strong> (Rating: {{ review.rating }}/5)</p>
                    <p>{{ review.comment }}</p>
                    <small>{{ review.created_at }}</small>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>No reviews yet.</p>
            {% endif %}
            {% endif %}
        </div>

        <!-- Cart Section -->
        <div id="cart-section" class="section" {% if section != 'cart' %}style="display: none;"{% endif %}>
            <h2>Your Cart</h2>
            {% if cart_items %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in cart_items %}
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>₹{{ "%.2f"|format(item.price) }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>₹{{ "%.2f"|format(item.item_total) }}</td>
                        <td>
                            <button onclick="removeFromCart({{ item.product_id }})" class="btn btn-danger btn-sm">Remove</button>
                        </td>
                    </tr>
                    {% endfor %}
                    <tr class="table-info">
                        <td colspan="4"><strong>Total</strong></td>
                        <td><strong>₹{{ "%.2f"|format(total) }}</strong></td>
                    </tr>
                </tbody>
            </table>
            <form id="order-form">
                <div class="mb-3">
                    <label for="shipping-address" class="form-label">Shipping Address</label>
                    <textarea class="form-control" id="shipping-address" name="shipping_address" required></textarea>
                </div>
                <div class="mb-3">
                    <label for="discount-code" class="form-label">Discount Code</label>
                    <input type="text" class="form-control" id="discount-code" name="discount_code">
                </div>
                <button type="submit" class="btn btn-primary btn-lg">Place Order</button>
            </form>
            {% else %}
            <div class="text-center py-5">
                <h4>Your cart is empty</h4>
                <a href="{{ url_for('index') }}" class="btn btn-primary">Continue Shopping</a>
            </div>
            {% endif %}
        </div>

        <!-- Order Section -->
        <div id="order-section" class="section" {% if section == 'order' %}style="display: block;"{% endif %}>
            {% if order %}
            <h2>Order #{{ order.order_id }}</h2>
            <div class="card">
                <div class="card-body">
                    <p><strong>Order Date:</strong> {{ order.order_date }}</p>
                    <p><strong>Total Amount:</strong> ₹{{ "%.2f"|format(order.total_amount) }}</p>
                    <p><strong>Status:</strong> <span class="badge bg-{{ 'success' if order.status == 'Delivered' else 'warning' }}">{{ order.status }}</span></p>
                    <p><strong>Shipping Address:</strong> {{ order.shipping_address }}</p>
                </div>
            </div>
            <h3 class="mt-4">Order Items</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order_items %}
                    <tr>
                        <td>{{ item.product_name }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>₹{{ "%.2f"|format(item.unit_price) }}</td>
                        <td>₹{{ "%.2f"|format(item.quantity * item.unit_price) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <a href="{{ url_for('index') }}" class="btn btn-primary">← Continue Shopping</a>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Add to cart
        function addToCart(productId) {
            fetch(`/add_to_cart/${productId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                showAlert(data.message, data.status);
                if (data.status === 'success') {
                    window.location.href = '/cart';
                }
            })
            .catch(error => {
                showAlert('Error adding to cart', 'danger');
            });
        }

        // Remove from cart
        function removeFromCart(productId) {
            fetch(`/remove_from_cart/${productId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                showAlert(data.message, data.status);
                if (data.status === 'success') {
                    window.location.href = '/cart';
                }
            })
            .catch(error => {
                showAlert('Error removing from cart', 'danger');
            });
        }

        // Show alert
        function showAlert(message, status) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${status} alert-dismissible fade show`;
            alert.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.getElementById('flash-messages').prepend(alert);
        }

        // Order form
        document.getElementById('order-form')?.addEventListener('submit', e => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            fetch('/place_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(data => {
                showAlert(data.message, data.status);
                if (data.status === 'success') {
                    window.location.href = `/order/${data.order_id}`;
                }
            });
        });

        // Initial section display
        document.addEventListener('DOMContentLoaded', function() {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                if (section.style.display !== 'none') {
                    section.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>